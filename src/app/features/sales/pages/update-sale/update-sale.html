<main class="w-full min-h-screen flex flex-col items-center justify-items-start">

    <header class="w-full bg-white min-h-[350px] shadow-xl flex flex-col items-center justify-center">

        <form class="w-full flex items-center justify-between px-20" [formGroup]="saleInfoForm" (ngSubmit)="saleInfoSubmitted$.next()">

            <!-- Right side -->
            <section class="flex flex-col items-start justify-items-start gap-2">

                <input type="text" class="text-xl font-bold px-6 py-2 rounded-2xl bg-blue-100" placeholder="Reference..." formControlName="reference">
                <p class="text-lg">Ordered: {{sale().orderedAt | date}}</p>
                <p class="text-lg">Sold by: <b>{{sale().soldBy | capitalizeFirst}}</b></p>

                <span class="flex items-center justify-items-start gap-2">

                <p class="text-lg">Delivered?</p>
                <input type="checkbox" class="w-8 h-8" formControlName="delivered">

            </span>

                <p>{{sale().orderId}}</p>

                <button type="submit" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-3xl transform transition-transform duration-300 hover:scale-110 cursor-pointer mt-2">Update sale info</button>

            </section>

            <section class="flex flex-col items-start justify-items-start gap-2 max-w-[30%] min-w-[20%]">

                <p><b>Previous delivery date</b>: {{sale().deliveryDate | date}}</p>
                <input type="date" class="px-6 py-2 rounded-2xl bg-blue-100 w-full" formControlName="deliveryDate">
                <input type="text" class="px-6 py-2 rounded-2xl bg-blue-100 w-full" placeholder="Address..."  formControlName="deliveryAddress">
                <input type="text" class="px-6 py-2 rounded-2xl bg-blue-100 w-full" placeholder="Phone number..."  formControlName="deliveryPhoneNumber">
                <input type="text" class="px-6 py-2 rounded-2xl bg-blue-100 w-full" placeholder="Extra information..."  formControlName="extraInformation">

            </section>

        </form>

        @if (saleInfoUpdated()) {

            <p class="text-green-600 text-2xl font-bold">Sale information updated successfully!</p>

        }

        @if (saleInfoUpdateError()) {

            <p class="text-2xl text-red-800">{{saleInfoUpdateError()}}</p>

        }

    </header>

    @if (saleProductsUpdateError()) {
        <p class="text-2xl text-red-800">{{ saleProductsUpdateError() }}</p>
    }

    <section class="w-full flex items-center justify-evenly mt-4">

        <button class="px-6 py-2 bg-slate-800 text-white font-bold rounded-2xl cursor-pointer transform transition-transform duration-300 hover:scale-105" (click)="clickedSubmitProductChanges()">Submit product changes</button>

        <span class="flex items-center justify-items-start gap-2">

            <p><b>Added items:</b> {{productsToAdd().length}}</p>
            <p><b>Removed items:</b> {{productsToRemove().length}}</p>

        </span>

    </section>

    <section class="w-full flex items-start justify-evenly">

        @if (productRetrievalError() === undefined) {

            <table class="w-[65%] mt-8 table-auto border-collapse shadow-lg rounded-xl overflow-hidden text-center">
                <thead class="bg-slate-900 text-white text-lg font-semibold">
                <tr>

                    <th class="p-3 border border-slate-950"></th>

                    <th class="p-3 border border-slate-950"></th>

                    <th class="p-3 border border-slate-950">Instance ID</th>

                    <th class="p-3 border border-slate-950">Product</th>

                    <th class="p-3 border border-slate-950">Colour</th>

                    <th class="p-3 border border-slate-950">Width</th>


                    <th class="p-3 border border-slate-950">Length</th>


                    <th class="p-3 border border-slate-950">Height</th>

                </tr>
                </thead>

                <tbody>
                    @for (added of productsToAdd(); track $index) {
                        <tr class="odd:bg-green-200 even:bg-green-300 hover:bg-green-400 transition">

                            <td class="p-3 border border-slate-300 bg-red-700 cursor-pointer" (click)="removeNewProduct($index)">

                                <svg viewBox="0 -0.5 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M6.96967 16.4697C6.67678 16.7626 6.67678 17.2374 6.96967 17.5303C7.26256 17.8232 7.73744 17.8232 8.03033 17.5303L6.96967 16.4697ZM13.0303 12.5303C13.3232 12.2374 13.3232 11.7626 13.0303 11.4697C12.7374 11.1768 12.2626 11.1768 11.9697 11.4697L13.0303 12.5303ZM11.9697 11.4697C11.6768 11.7626 11.6768 12.2374 11.9697 12.5303C12.2626 12.8232 12.7374 12.8232 13.0303 12.5303L11.9697 11.4697ZM18.0303 7.53033C18.3232 7.23744 18.3232 6.76256 18.0303 6.46967C17.7374 6.17678 17.2626 6.17678 16.9697 6.46967L18.0303 7.53033ZM13.0303 11.4697C12.7374 11.1768 12.2626 11.1768 11.9697 11.4697C11.6768 11.7626 11.6768 12.2374 11.9697 12.5303L13.0303 11.4697ZM16.9697 17.5303C17.2626 17.8232 17.7374 17.8232 18.0303 17.5303C18.3232 17.2374 18.3232 16.7626 18.0303 16.4697L16.9697 17.5303ZM11.9697 12.5303C12.2626 12.8232 12.7374 12.8232 13.0303 12.5303C13.3232 12.2374 13.3232 11.7626 13.0303 11.4697L11.9697 12.5303ZM8.03033 6.46967C7.73744 6.17678 7.26256 6.17678 6.96967 6.46967C6.67678 6.76256 6.67678 7.23744 6.96967 7.53033L8.03033 6.46967ZM8.03033 17.5303L13.0303 12.5303L11.9697 11.4697L6.96967 16.4697L8.03033 17.5303ZM13.0303 12.5303L18.0303 7.53033L16.9697 6.46967L11.9697 11.4697L13.0303 12.5303ZM11.9697 12.5303L16.9697 17.5303L18.0303 16.4697L13.0303 11.4697L11.9697 12.5303ZM13.0303 11.4697L8.03033 6.46967L6.96967 7.53033L11.9697 12.5303L13.0303 11.4697Z" fill="#000000"></path> </g></svg>

                            </td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{$index}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{ added.instanceId }}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{added.productName | capitalizeFirst}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{added.colour ? added.colour : "N/A"}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{added.width ? added.width : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{added.length ? added.length : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{added.height ? added.height : "N/A"}}</td>


                        </tr>
                    }

                    @if (productsToAdd().length > 0) {
                        <tr class="h-2 bg-slate-800"></tr>
                    }

                    @for (inst of saleProducts(); track $index) {
                        <tr class="odd:bg-slate-100 even:bg-slate-50 hover:bg-slate-200 transition">

                            <td class="p-3 border border-slate-300 bg-red-700 cursor-pointer" (click)="chooseProductForRemoval($index)">

                                <svg viewBox="0 -0.5 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M6.96967 16.4697C6.67678 16.7626 6.67678 17.2374 6.96967 17.5303C7.26256 17.8232 7.73744 17.8232 8.03033 17.5303L6.96967 16.4697ZM13.0303 12.5303C13.3232 12.2374 13.3232 11.7626 13.0303 11.4697C12.7374 11.1768 12.2626 11.1768 11.9697 11.4697L13.0303 12.5303ZM11.9697 11.4697C11.6768 11.7626 11.6768 12.2374 11.9697 12.5303C12.2626 12.8232 12.7374 12.8232 13.0303 12.5303L11.9697 11.4697ZM18.0303 7.53033C18.3232 7.23744 18.3232 6.76256 18.0303 6.46967C17.7374 6.17678 17.2626 6.17678 16.9697 6.46967L18.0303 7.53033ZM13.0303 11.4697C12.7374 11.1768 12.2626 11.1768 11.9697 11.4697C11.6768 11.7626 11.6768 12.2374 11.9697 12.5303L13.0303 11.4697ZM16.9697 17.5303C17.2626 17.8232 17.7374 17.8232 18.0303 17.5303C18.3232 17.2374 18.3232 16.7626 18.0303 16.4697L16.9697 17.5303ZM11.9697 12.5303C12.2626 12.8232 12.7374 12.8232 13.0303 12.5303C13.3232 12.2374 13.3232 11.7626 13.0303 11.4697L11.9697 12.5303ZM8.03033 6.46967C7.73744 6.17678 7.26256 6.17678 6.96967 6.46967C6.67678 6.76256 6.67678 7.23744 6.96967 7.53033L8.03033 6.46967ZM8.03033 17.5303L13.0303 12.5303L11.9697 11.4697L6.96967 16.4697L8.03033 17.5303ZM13.0303 12.5303L18.0303 7.53033L16.9697 6.46967L11.9697 11.4697L13.0303 12.5303ZM11.9697 12.5303L16.9697 17.5303L18.0303 16.4697L13.0303 11.4697L11.9697 12.5303ZM13.0303 11.4697L8.03033 6.46967L6.96967 7.53033L11.9697 12.5303L13.0303 11.4697Z" fill="#000000"></path> </g></svg>

                            </td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{$index}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{ inst.instanceId }}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{inst.productName | capitalizeFirst}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{inst.colour ? inst.colour : "N/A"}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{inst.width ? inst.width : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{inst.length ? inst.length : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{inst.height ? inst.height : "N/A"}}</td>


                        </tr>
                    }

                    @if (productsToRemove().length > 0) {
                        <tr class="h-2 bg-slate-800"></tr>
                    }

                    @for (removed of productsToRemove(); track $index) {
                        <tr class="odd:bg-red-500/50 even:bg-red-400/50 hover:bg-red-500/70 transition">

                            <td class="p-3 border border-slate-300 text-slate-900 bg-red-700 font-bold cursor-pointer" (click)="addProductBackToSale($index)">

                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 inline"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 3C12.2652 3 12.5196 3.10536 12.7071 3.29289L19.7071 10.2929C20.0976 10.6834 20.0976 11.3166 19.7071 11.7071C19.3166 12.0976 18.6834 12.0976 18.2929 11.7071L13 6.41421V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V6.41421L5.70711 11.7071C5.31658 12.0976 4.68342 12.0976 4.29289 11.7071C3.90237 11.3166 3.90237 10.6834 4.29289 10.2929L11.2929 3.29289C11.4804 3.10536 11.7348 3 12 3Z" fill="#07ed4c"></path> </g></svg>

                            </td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{$index}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{ removed.instanceId }}</td>

                            <td class="p-3 border border-slate-300 text-slate-900 font-medium">{{removed.productName | capitalizeFirst}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{removed.colour ? removed.colour : "N/A"}}</td>

                            <td class="p-3 border border-slate-300 text-slate-900">{{removed.width ? removed.width : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{removed.length ? removed.length : "N/A"}}</td>


                            <td class="p-3 border border-slate-300 text-slate-900">{{removed.height ? removed.height : "N/A"}}</td>


                        </tr>
                    }
                </tbody>
            </table>

        } @else {

            <p class="text-2xl text-red-800">{{ productRetrievalError() }}</p>

        }

        <!-- Right side form to add new products to the sale -->
        <form class="flex flex-col min-w-[30%] items-start justify-items-start mt-8" [formGroup]="searchForm">

            <h1 class="text-2xl font-semibold self-center mb-2">Product selection</h1>

            @if (!selectedProduct()) {

                <input type="text" placeholder="Product name..." class="w-full rounded-2xl border border-gray-300 bg-white px-3 py-2 text-gray-700 shadow-sm
         focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4" formControlName="name">

            } @else {

                <div class="w-full bg-slate-800 rounded-2xl py-2 px-6 flex items-center justify-between mt-4">

                    <h1 class="text-2xl text-white">{{selectedProduct()!.name | capitalizeFirst}}</h1>

                    <button type="button" class="py-2 px-4 bg-red-600 rounded-xl font-bold transform transition-transform duration-300 hover:scale-105" (click)="unselectCurrentProduct()">X</button>

                </div>

                <form class="w-full bg-slate-800 rounded-2xl py-2 px-6 flex items-center justify-between my-4 gap-2" [formGroup]="productOptionsForm">

                    @if (selectedProduct()!.groupByWidth) {
                        <input type="text" id="width" name="width" placeholder="width" class="bg-white px-4 py-2 rounded-xl" formControlName="width">
                    }

                    @if (selectedProduct()!.groupByLength) {
                        <input type="text" id="length" name="length" placeholder="length" class="bg-white px-4 py-2 rounded-xl" formControlName="length">
                    }

                    @if (selectedProduct()!.groupByHeight) {
                        <input type="text" id="height" name="height" placeholder="height" class="bg-white px-4 py-2 rounded-xl" formControlName="height">
                    }

                    @if (selectedProduct()!.groupByColour) {
                        <input type="text" id="colour" name="colour" placeholder="colour" class="bg-white px-4 py-2 rounded-xl" formControlName="colour">
                    }

                    <button type="button" class="px-4 py-2 bg-blue-300 rounded-xl font-bold" (click)="getInstancesOfCurrentSelection()">Find</button>

                </form>

            }

            @if (productResults().length > 0 && !selectedProduct()) {

                @for (res of productResults(); track res.productId) {

                    <div class="w-full rounded-2xl border border-gray-300 bg-white px-3 py-2 text-gray-700 shadow-sm flex items-center justify-between mb-2
                    hover:text-blue-300 transform transition-transform duration-300 hover:scale-105 cursor-pointer" (click)="selectProduct(res.productId)">

                        <p>{{res.name | capitalizeFirst}}</p>

                        <p>{{res.factoryName}}</p>

                    </div>

                }

            }

            @if (productInstanceResults().length > 0 && selectedProduct()) {

                @for (res of productInstanceResults(); track $index) {

                    <div class="w-full rounded-2xl border border-gray-300 bg-white px-3 py-2 text-gray-700 shadow-sm flex items-center justify-between mb-2
                    hover:text-blue-300 transform transition-transform duration-300 hover:scale-105 cursor-pointer" (click)="addInstanceToSale(res)">

                        <p>{{ $index }}</p>

                        <p>{{ res.instanceId }}</p>

                    </div>

                }

            }

            @if (productSearchError()) {
                <p class="text-2xl text-red-800">{{ productSearchError() }}</p>
            }

        </form>

    </section>


</main>
